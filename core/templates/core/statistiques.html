{% extends "core/base.html" %}
{% load static %}

{% block title %}Statistiques | EduConnect{% endblock %}

{% block header %}
    <i class="fas fa-chart-pie me-2"></i> Statistiques de Présence
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Filtre par cours -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <label for="cours" class="form-label">Filtrer par cours</label>
                    <select name="cours" id="cours" class="form-select" onchange="this.form.submit()">
                        <option value="">Tous les cours</option>
                        {% for c in cours_options %}
                            <option value="{{ c.id }}" {% if c.id|stringformat:"s" == request.GET.cours %}selected{% endif %}>
                                {{ c.nom }} - {{ c.classe.nom }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end justify-content-md-end">
                    <a href="#" onclick="exportToPDF()" class="btn btn-outline-danger me-2">
                        <i class="fas fa-file-pdf me-2"></i> PDF
                    </a>
                    <a href="#" onclick="exportToExcel()" class="btn btn-outline-success">
                        <i class="fas fa-file-excel me-2"></i> Excel
                    </a>
                </div>
            </form>
        </div>
    </div>

    {% if stats %}
        <!-- Accordion des cours -->
        <div class="accordion" id="courseAccordion">
            {% for s in stats %}
                <div class="accordion-item mb-3 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                    <h2 class="accordion-header" id="heading-{{ s.cours.id }}">
                        <button class="accordion-button bg-white text-dark rounded-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ s.cours.id }}" aria-expanded="true" aria-controls="collapse-{{ s.cours.id }}">
                            <i class="fas fa-book me-2"></i>
                            <strong>{{ s.cours.nom }}</strong>
                            <span class="text-muted ms-2">• {{ s.cours.classe.nom }}</span>
                            <span class="ms-auto badge bg-primary">{{ s.total_seances }} séances</span>
                        </button>
                    </h2>
                    <div id="collapse-{{ s.cours.id }}" class="accordion-collapse collapse show" data-bs-parent="#courseAccordion">
                        <div class="accordion-body bg-light p-4">
                            <div class="row g-4 mb-4">
                                <!-- Statistiques globales -->
                                <div class="col-lg-8">
                                    <h5><i class="fas fa-chart-pie me-2"></i> Répartition globale</h5>
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="globalChart-{{ s.cours.id }}"></canvas>
                                    </div>
                                </div>
                                <!-- Résumé chiffré -->
                                <div class="col-lg-4">
                                    <h5><i class="fas fa-info-circle me-2"></i> Totaux</h5>
                                    <div class="list-group list-group-flush mt-3">
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Présents</span>
                                            <span class="badge bg-success">{{ s.global.present }}</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Retards</span>
                                            <span class="badge bg-warning text-dark">{{ s.global.retard }}</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Absents</span>
                                            <span class="badge bg-danger">{{ s.global.absent }}</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>Motif</span>
                                            <span class="badge bg-info">{{ s.global.motif }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tableau par étudiant -->
                            <h5><i class="fas fa-users me-2"></i> Détails par étudiant</h5>
                            <div class="table-responsive mt-3">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Étudiant</th>
                                            <th>Présent</th>
                                            <th>Retard</th>
                                            <th>Absent</th>
                                            <th>Motif</th>
                                            <th>Taux</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for e in s.etudiants_stats %}
                                            <tr>
                                                <td>{{ e.etudiant.get_full_name }}</td>
                                                <td>{{ e.present }}</td>
                                                <td>{{ e.retard }}</td>
                                                <td>{{ e.absent }}</td>
                                                <td>{{ e.motif }}</td>
                                                <td>
                                                    <span class="badge bg-{% if e.taux_presence >= 75 %}success{% else %}danger{% endif %}">
                                                        {{ e.taux_presence|floatformat:0 }}%
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#studentModal" data-name="{{ e.etudiant.get_full_name }}" data-stats='{"present": {{ e.present }}, "retard": {{ e.retard }}, "absent": {{ e.absent }}, "motif": {{ e.motif }}, "taux": {{ e.taux_presence|floatformat:0 }}}'>
                                                        <i class="fas fa-chart-bar"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-chart-line text-muted" style="font-size: 5rem; opacity: 0.3;"></i>
            <h4 class="text-muted mt-3">Aucune donnée disponible</h4>
            <p class="text-muted">Aucun cours n’a encore de présences enregistrées.</p>
        </div>
    {% endif %}
</div>

<!-- Modal Étudiant -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalStudentName">Détails de l'étudiant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="modalChart"></canvas>
                </div>
                <div id="modalDetails" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Générer les graphiques pour chaque cours
    {% for s in stats %}
        const ctx{{ s.cours.id }} = document.getElementById('globalChart-{{ s.cours.id }}').getContext('2d');
        new Chart(ctx{{ s.cours.id }}, {
            type: 'doughnut',
            data: {
                labels: ['Présent', 'Retard', 'Absent', 'Motif'],
                datasets: [{
                    data: [
                        {{ s.global.present }},
                        {{ s.global.retard }},
                        {{ s.global.absent }},
                        {{ s.global.motif }}
                    ],
                    backgroundColor: [
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#3b82f6'
                    ],
                    borderWidth: 0,
                    cutout: '70%'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    {% endfor %}

    // Gérer le modal étudiant
    const modal = document.getElementById('studentModal');
    const modalChart = new Chart(document.getElementById('modalChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Présent', 'Retard', 'Absent', 'Motif'],
            datasets: [{
                label: 'Présence',
                data: [0, 0, 0, 0],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6']
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    modal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const name = button.getAttribute('data-name');
        const stats = JSON.parse(button.getAttribute('data-stats'));

        document.getElementById('modalStudentName').textContent = name;

        modalChart.data.datasets[0].data = [stats.present, stats.retard, stats.absent, stats.motif];
        modalChart.update();

        document.getElementById('modalDetails').innerHTML = `
            <p><strong>Taux de présence:</strong> ${stats.taux}%</p>
        `;
    });

    // Export
    function exportToPDF() {
        const coursId = document.getElementById('cours').value || 'all';
        window.location.href = `{% url 'core:export_pdf_statistiques' 0 %}`.replace('0', coursId);
    }

    function exportToExcel() {
        const coursId = document.getElementById('cours').value || 'all';
        window.location.href = `{% url 'core:export_excel' 0 %}`.replace('0', coursId);
    }
</script>
{% endblock %}
