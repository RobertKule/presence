{% extends "base.html" %}

{% block title %}Faire l'appel - {{ course.name }}{% endblock %}

{% block content %}
<div class="container-lg">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-clipboard-check text-primary me-2"></i>
            Faire l'appel - {{ course.name }}
        </h1>
        <a href="{{ url_for('course', course_name=course.name) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Retour
        </a>
    </div>

    <form method="POST" action="{{ url_for('take_attendance', course_name=course.name) }}" class="needs-validation" novalidate>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h2 class="h5 mb-0">
                            <i class="bi bi-calendar-date me-2"></i>
                            Séance du jour
                        </h2>
                    </div>
                    <div class="col-md-6">
                        <input type="date" class="form-control bg-white" name="date" value="{{ today }}" required>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                {% if students %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">ID</th>
                                <th width="35%">Nom complet</th>
                                <th width="20%">Matricule</th>
                                <th width="40%">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr class="align-middle">
                                <td class="fw-bold">{{ student.id }}</td>
                                <td>{{ student.full_name }}</td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ student.matricule if student.matricule else 'N/A' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <input type="radio" class="btn-check" 
                                               name="status_{{ student.id }}" 
                                               id="present_{{ student.id }}" 
                                               value="present" autocomplete="off" checked>
                                        <label class="btn btn-outline-success px-3" for="present_{{ student.id }}">
                                            <i class="bi bi-check-circle me-1"></i>Présent
                                        </label>

                                        <input type="radio" class="btn-check" 
                                               name="status_{{ student.id }}" 
                                               id="late_{{ student.id }}" 
                                               value="late" autocomplete="off">
                                        <label class="btn btn-outline-warning px-3" for="late_{{ student.id }}">
                                            <i class="bi bi-clock-history me-1"></i>Retard
                                        </label>

                                        <input type="radio" class="btn-check" 
                                               name="status_{{ student.id }}" 
                                               id="absent_{{ student.id }}" 
                                               value="absent" autocomplete="off">
                                        <label class="btn btn-outline-danger px-3" for="absent_{{ student.id }}">
                                            <i class="bi bi-x-circle me-1"></i>Absent
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning m-4">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Aucun étudiant n'a été importé pour ce cours.
                    <a href="{{ url_for('upload_students', course_name=course.name) }}" class="alert-link">
                        Importer des étudiants
                    </a>
                </div>
                {% endif %}
            </div>
            
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        {{ students|length }} étudiant(s) à marquer
                    </small>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-save me-1"></i>
                        Enregistrer l'appel
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Script pour mémoriser les sélections pendant la session
document.addEventListener('DOMContentLoaded', function() {
    // Validation Bootstrap
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    }, false);

    // Sauvegarde des sélections en localStorage
    const radioButtons = document.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(radio => {
        // Restaurer les sélections précédentes
        const savedStatus = localStorage.getItem(`attendance_${radio.name}`);
        if (savedStatus && radio.value === savedStatus) {
            radio.checked = true;
        }

        // Sauvegarder les nouvelles sélections
        radio.addEventListener('change', function() {
            localStorage.setItem(`attendance_${this.name}`, this.value);
        });
    });

    // Bouton pour tout marquer comme présent
    const markAllPresent = document.createElement('button');
    markAllPresent.type = 'button';
    markAllPresent.className = 'btn btn-sm btn-outline-success me-2';
    markAllPresent.innerHTML = '<i class="bi bi-check-all me-1"></i>Tout présent';
    markAllPresent.addEventListener('click', function() {
        document.querySelectorAll('input[value="present"]').forEach(radio => {
            radio.checked = true;
            localStorage.setItem(`attendance_${radio.name}`, 'present');
        });
    });

    document.querySelector('.card-footer').prepend(markAllPresent);
});
</script>

<style>
.attendance-actions .btn {
    transition: all 0.2s;
}
.btn-check:checked + .btn-outline-success {
    background-color: var(--bs-success);
    color: white;
}
.btn-check:checked + .btn-outline-warning {
    background-color: var(--bs-warning);
    color: black;
}
.btn-check:checked + .btn-outline-danger {
    background-color: var(--bs-danger);
    color: white;
}
.table-hover tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}
</style>
{% endblock %}